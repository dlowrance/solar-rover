<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="stylesheet" href="/css/tailwind.min.css" />

    <style>
        html {
            background: #555;
        }
        body{
            margin:0 auto;
            padding:0;
            width:100%;
            max-width: 468px;
            height: 100%;
            max-height: 100%;
            font-weight:100;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        }
        h2 {
            font-size: 28px;
        }
        #cursor {
            cursor: pointer;
            display: inline-block;
            background: rgba(112, 128, 144, 0.5);
            box-sizing: border-box;
            border: 1px solid rgba(112, 128, 144, 1);
            border-radius: 50%;
            z-index: 100;
        }
        .hidden {
            display: none;
        }
        img.offline {
            opacity: 0.25;
        }
        #canvas {
            margin: 0 auto;
            border-radius: 50%;
            z-index: 100;
        }
        #origin {
            opacity: 0.1;
            display: inline-block;
            background: #fff;
            border: 1px solid #444;
            border-radius: 50%;
            box-sizing: border-box;
            z-index: 10;
        }
        #origin.active {
            background: #008000;
            opacity: 1;
        }
        .coords {
            color: #fff;
        }

        .dial {
            /*width: 600px;*/
            height: 2px;
            position: absolute;
            transform-origin: left;
            background: rgba(112, 128, 144, 1);
            opacity: 0;
            transition: opacity 0.25s;
        }

        .dial.abs {
            z-index: 1;
        }

        .dial.abs, .dial.max {
            left: 50%;
            /* top: 50%; */
        }

        .dial.max {
            background: rgba(112, 128, 144, 0.5);
        }

        .dial-container {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            overflow: hidden;
        }

        #camera-feed {
            color: #fff;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #camera-feed img {
            width: 100%;
            margin: 1rem 0 2rem 0;
        }

        .app-container {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-direction: column;
            background: #000;
            width: 100%;
            height: 100%s;
            max-width: 468px;
        }

        #canvas-container {
            box-sizing: border-box;
            border: 1px #555 solid;
            border-radius: 50%;
            width: 80%;
            z-index: 10;
            /*background-image: radial-gradient(circle, #333333, #282828, #1d1d1d, #121212, #000000);*/
            /*background-image: linear-gradient(to bottom, #333333, #282828, #1d1d1d, #121212, #000000);*/
            background-color: #222;
            margin-bottom: 1rem;
        }
        #front-camera {
            background-color: #555;
        }

    </style>
    <title>Wi-Fi Rover</title>
</head>
<body>

    <div class="app-container">
        <div style="position: absolute; top: 0; left: 0;" class="coords">
            <div class="hidden">
                <span id="posX"></span>, <span id="posY"></span>
            </div>
            <div>
                <span id="direction"></span>
            </div>
            <div class="hidden">diameter: <span id="diameter"></span></div>
        </div>

        <div id="camera-feed">
            <img src="/stream" id="front-camera" alt="Front Camera" onerror="this.onerror=null; this.src='img/onerror.png'; this.classList='offline';" />
        </div>

        <div id="canvas-container">
            <div id="canvas">
                <div id="cursor" data-coords="{x:0, y:0}"></div>
            	<div id="origin" class="inactive"></div>
            </div>
        </div>
        <div class="dial-container" style="display: none;">
            <div class="dial abs"></div>
            <div class="dial max"></div>
        </div>

        <link rel="stylesheet" href="/css/tabler-icons.min.css">
        <i class="ti ti-settings toggle-settings"></i>
        <style>
            .ti-settings, .ti-arrow-bar-to-up {
                cursor: pointer;
                opacity: 0.5;
                position: absolute;
                color: #555;
                font-size: 42px;
                padding: 3px 3px 5px 3px;
                border: 1px #555 solid;
                border-radius: 5px;
                right: 10px;
                bottom: 10px;
                background: #121212;
                transition: opacity 0.05s ease-out;
            }
            .ti-settings:active, .ti-settings:focus, .ti-arrow-bar-to-up:active, .ti-arrow-bar-to-up:focus {
                opacity: 1;
            }
            #settings {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
                height: 100%;
                max-width: 468px;
                position: absolute;
                top: -100%;
                color: #ccc;
                background: #222;
                z-index: 100;
                transition: top 0.23s ease-in-out;
            }

            #settings .spacer {
                padding: 10px;
                width: 100%;
            }
            #settings label {
                margin-left: 1em;
                color: #ccc;
            }
            #settings.active {
                top: 0;
            }
            #settings .option-settings {
                justify-content: space-between;
                padding: 20px;
            }
            #settings .option {
                border-bottom: 1px #555 solid;
                width: 100%;
            }
            #settings .option .form-check-label {
                font-size: 28px;
                width: 100%;
                margin: 0;
            }
            #settings .option.selection {
                background: #111;
            }
            #settings .option-status {
                flex-direction: column;
            }
            #settings .option-restart {

                border-top: 1px #555 solid;
            }
            #settings #uptime {
                background: #222;
                border-top: 1px #555 solid;
                padding: 20px;
            }
            #settings .restart.active {
                text-shadow: 0 0 5px red;
                color: red;
            }

            #settings .ti {
                font-size: 38px;
            }

            div.disabled {
                opacity: 0.50;
            }


            .slide-to-unlock {
                /* background: green!important; */
            }
            .after-unlock {
                display: none!important;
            }
            .slide-to-unlock > .after-unlock {
                display: flex!important;
            }

            .slide-to-unlock > .before-unlock {
                display: none!important;
            }

            .str {
                position: absolute;
                color: #222;
                width: 71.5%;
                text-align: center;
                line-height: 44px;
                text-transform: uppercase;
            }


            /* tailwind overrides */
            .form-check-input:checked {
                background-color: green;
                border-color: green;
            }
            .form-switch {
                display: flex;
                justify-content: space-between;
                padding: 20px 25px;
                width: 100%;
            }
            /* tailwind overrides */

            .noselect {
              -webkit-touch-callout: none; /* iOS Safari */
                -webkit-user-select: none; /* Safari */
                 -khtml-user-select: none; /* Konqueror HTML */
                   -moz-user-select: none; /* Old versions of Firefox */
                    -ms-user-select: none; /* Internet Explorer/Edge */
                        user-select: none; /* Non-prefixed version, currently
                                              supported by Chrome, Edge, Opera and Firefox */
            }



        </style>
        <div id="settings">
            <div class="flex option option-settings">
                <i class="ti ti-adjustments-horizontal toggle-settings" style="font-size: 38px; margin-right: 10px;"></i><h2 style="font-weight: bold;">Settings</h2>
                <div id="current-time"></div>
            </div>
            <div class="flex option selection">
                <div class="form-check form-switch">
                    <label class="form-check-label inline-block text-gray-800" for="camera">Camera</label>
                    <input class="option-camera form-check-input appearance-none w-20 -ml-10 rounded-full float-left align-top bg-white bg-no-repeat bg-contain bg-gray-300 focus:outline-none cursor-pointer shadow-sm" style="height: 38px;" type="checkbox" role="switch" id="camera">
                </div>
            </div>

            <div class="flex option option-status selection">
                <div class="form-check form-switch">
                    <label class="form-check-label inline-block text-gray-800">Status</label>
                    <i class="ti ti-activity"></i>
                </div>
                <div id="uptime">Tap Status to update</div>
            </div>

            <!--
            <div class="flex option selection disabled">
                <div class="form-check form-switch">
                <label class="form-check-label inline-block text-gray-800">~ $ terminal</label>
                <i class="ti ti-terminal-2"></i>
                </div>
            </div>
            -->

            <!--
            <div class="spacer"></div>
            -->

            <div class="flex option option-restart selection noselect">
                <div class="form-check form-switch before-unlock">
                    <label class="form-check-label inline-block text-gray-800">Restart <span id="clicksToUnlock"></span></label>
                    <i class="ti ti-power restart"></i>
                </div>
                <div class="form-check form-switch after-unlock">
                    <div class="str">Slide to Restart</div>
                    <input type="range" value="0" class="pullee" />
                    <i class="ti ti-power restart"></i>
                </div>
            </div>

            <i class="ti ti-arrow-bar-to-up toggle-settings"></i>
        </div>

    </div>
</body>
</html>
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery-ui.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
/*!
 * jQuery UI Touch Punch 0.2.3
 *
 * Copyright 2011�2014, Dave Furfero
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Depends:
 *  jquery.ui.widget.js
 *  jquery.ui.mouse.js
 */
!function(a){function f(a,b){if(!(a.originalEvent.touches.length>1)){a.preventDefault();var c=a.originalEvent.changedTouches[0],d=document.createEvent("MouseEvents");d.initMouseEvent(b,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null),a.target.dispatchEvent(d)}}if(a.support.touch="ontouchend"in document,a.support.touch){var e,b=a.ui.mouse.prototype,c=b._mouseInit,d=b._mouseDestroy;b._touchStart=function(a){var b=this;!e&&b._mouseCapture(a.originalEvent.changedTouches[0])&&(e=!0,b._touchMoved=!1,f(a,"mouseover"),f(a,"mousemove"),f(a,"mousedown"))},b._touchMove=function(a){e&&(this._touchMoved=!0,f(a,"mousemove"))},b._touchEnd=function(a){e&&(f(a,"mouseup"),f(a,"mouseout"),this._touchMoved||f(a,"click"),e=!1)},b._mouseInit=function(){var b=this;b.element.bind({touchstart:a.proxy(b,"_touchStart"),touchmove:a.proxy(b,"_touchMove"),touchend:a.proxy(b,"_touchEnd")}),c.call(b)},b._mouseDestroy=function(){var b=this;b.element.unbind({touchstart:a.proxy(b,"_touchStart"),touchmove:a.proxy(b,"_touchMove"),touchend:a.proxy(b,"_touchEnd")}),d.call(b)}}}(jQuery);
</script>
<script>
var cfg = {
	canvas_id: 'canvas',
	cursor_id: 'cursor',
	origin_id: 'origin',
	canvas_diameter: $('body').width() * 0.8,
	cursor_diameter: 60, //pixels
	cursor_origin: null
}
function draw() {
	var canvas = $('#'+cfg.canvas_id);
	var cursor = $('#'+cfg.cursor_id);
	var origin = $('#'+cfg.origin_id);
	var window_height = $('body').height();
	var window_width = $('body').width();
    if (window_width > window_height) {
        cfg.canvas_diameter = window_height * 0.8;
    }
    $('#diameter').html(parseInt(cfg.canvas_diameter));

	canvas.css({width: cfg.canvas_diameter, height: cfg.canvas_diameter});
	cursor
		.css({width: cfg.cursor_diameter, height: cfg.cursor_diameter})
		.offset({
				left: canvas.offset().left + (cfg.canvas_diameter*0.5 - cfg.cursor_diameter*0.5),
				top: canvas.offset().top + (cfg.canvas_diameter*0.5 - cfg.cursor_diameter*0.5)
			});
	//set adjusted origin for view port
	cfg.cursor_origin = {
		x: cursor.offset().left,
		y: cursor.offset().top
	};
	//this is static
	origin
		.css({width: cfg.cursor_diameter*0.25, height: cfg.cursor_diameter*0.25})
		.offset({
			left: canvas.offset().left + canvas.width()*0.5 - cfg.cursor_diameter*0.25/2,
			top: canvas.offset().top + canvas.height()*0.5 - cfg.cursor_diameter*0.25/2
		});
}



var socket = io({
    path: '/ws',
    //these two values help with prolonged periods of no activity but remaining connected
    transports: ['websocket'],
    upgrade: false
});

// STATUS
socket.on('connect', function() {
    status('connected');
});
socket.on('disconnect', function() {
    status('disconnected');
});

var _settings = {
    camera: {},
};

$(document).ready(function() {
	//init
	draw();

    var window_height = $('body').height();
    $('.app-container').css({height: window_height + 'px'});

    var currentMousePos = {x:0, y:0};
    $('#canvas').on('click', function(event) {
        currentMousePos.x = event.pageX;
        currentMousePos.y = event.pageY;
        console.log(currentMousePos);
    });

    $('#camera-feed img').css({'min-height': ($('body').width() * 0.75) + 'px'}); // 4:3 aspect ratio
    //set position after image is loaded
    $('#camera-feed img').one('load', function() {
        $('.dial.abs, .dial.max').css({top: ($('#canvas-container').position().top + $('#canvas').height()/2) + 'px'});
    });

    $('#front-camera').on('click', function() {
        if ($('#front-camera').hasClass('offline') == false) {
            $('#front-camera').attr('src', '/stream?' + Date.now());
        }
    });

    // settings
    $('.toggle-settings').on('click', function() {
        if ($('#settings').hasClass('active')) {
            $('#settings').removeClass('active');
        }
        else {
            $('#settings').addClass('active');
        }

        setSettingsTime();
    });

    $('.option-camera').on('click', function(e) {
        var is_checked = $('.option-camera').is(':checked');
        if (is_checked) {
            socket.emit('settings', {
                camera: 'on'
            });
        }
        else {
            socket.emit('settings', {
                camera: 'off'
            });
        }
    });

    $('.option-status .form-check').on('click', function() {
        socket.emit('get', 'uptime');
    });

    $('.restart').on('click', function() {
        if ($('.restart').hasClass('active')) {
            if (confirm('Are you sure you want to restart?')) {
                $('.option-restart .form-check').html('<label class="form-check-label inline-block text-gray-800" style="text-align: center">RESTARTING...</label>');
                socket.emit('RESTART');
            }
            else {
                resetRestart();
            }
        }
    });

    //setup before functions
    var typingTimer;
    var doneTypingInterval = 1000;
    var $input = $('.option-restart');
    var clicksToUnlock = 5;

    //on keyup, start the countdown
    $input.on('mouseup', function () {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(doneTyping, doneTypingInterval);
    });

    //on keydown, clear the countdown
    $input.on('mousedown', function () {
        clearTimeout(typingTimer);
        $('#clicksToUnlock').html('(Tap again ' + clicksToUnlock + ')');
        if (clicksToUnlock <= 0) {
            $('#clicksToUnlock').html('(Unlocked)');
            $input.addClass('slide-to-unlock');

            setTimeout(function() {
                resetRestart();
            }, 7500);
        }
        clicksToUnlock--;
    });

    //user is "finished typing," do something
    function doneTyping () {
      //do something
      console.log('reset clicks');
      clicksToUnlock = 5;
      $('#clicksToUnlock').html('');
    }

    $('.option-restart').on('click', function() {
        console.log('clicked');
    });

});

// set settings
socket.on('settings', function(settings) {
    _settings = settings;
    setSettings(_settings);
});

function setSettings(settings) {
    setSettingsTime();

    if (settings === 0) return;

    if (settings.camera == 'on') {
        $('.option-camera').attr('checked', true);
        $('#front-camera').removeClass('offline');
    }
    else {
        $('.option-camera').attr('checked', false);
        $('#front-camera').addClass('offline').attr('src', 'img/onerror.png?' + Date.now());
    }

    if ('uptime' in settings) {
        $('#uptime').html(settings.uptime);
    }

}

$(function() {
    var x_coord = 0;
    var y_coord = 0;
    $('#' + cfg.cursor_id).draggable({
        start: function() {
            //$('.hidden').addClass('show').removeClass('hidden');
            $('.dial').css({
                opacity: 1
            });
        },
        drag: function(e, ui) {
            var r = cfg.canvas_diameter * 0.5,
                small_r = cfg.cursor_diameter * 0.5,
                origin_x = r - small_r,
                origin_y = r - small_r,
                x = ui.position.left - origin_x,
                y = ui.position.top - origin_y,
                l = Math.sqrt(x * x + y * y),
                l_in = Math.min(r - small_r, l),
                left = parseInt(x / l * l_in + origin_x),
                top = parseInt(y / l * l_in + origin_y);

            ui.position = {
                left: left,
                top: top
            };
            //coords upper left
            x_coord = parseInt(left - (parseInt(cfg.canvas_diameter) / 2 - cfg.cursor_diameter / 2));
            y_coord = -parseInt(top - (parseInt(cfg.canvas_diameter) / 2 - cfg.cursor_diameter / 2));



            var radius = parseInt((cfg.canvas_diameter / 2) - (cfg.cursor_diameter / 2));
            var decimal = {x:0, y:0};
            decimal.x = x_coord / radius;
            decimal.y = y_coord / radius;

            $('#posX').text(parseInt(decimal.x * 100)  + '%');
            $('#posY').text(parseInt(decimal.y * 100) + '%');

            var theta = Math.atan(y_coord / x_coord) * 180 / Math.PI;
            if (x_coord >= 0 && y_coord >= 0) {
                theta = theta
            } else if (x_coord < 0 && y_coord) {
                theta = 180 - Math.atan(y_coord / -x_coord) * 180 / Math.PI;
                if (theta == 270) theta = 90;
            } else if (y_coord <= 0 && x_coord < 0) {
                if (theta == 0) theta = 180;
            } else if (y_coord < 0 && x_coord >= 0) {
                theta = 360 + theta;
            } else {
                //nothing
            }


            var direction = Math.cos(theta * Math.PI / 180) * 100;
            var power_direction = (decimal.y >= 0) ? 1 : -1;
            var power = power_direction * parseInt(Math.sqrt(decimal.x * decimal.x + decimal.y * decimal.y) * 100);

            //console.log(direction);

            // Drive the rover!
            driveRover({
                direction: direction,
                power: power
            });



            $('.dial').css({
                transform: 'rotate(-' + theta + 'deg)'
            });
        },
        stop: function() {
            //$('.show').addClass('hidden').removeClass('show');
            $('.dial').css({
                opacity: 0
            });

            driveRover({
                direction: 0,
                power: 0
            });
        },
        revert: true,
        revertDuration: 100
    });

    var dial = $('.dial');
    var dialMax = $('.dial.max');
    setInterval(function() {
        dial.css({
            width: (cfg.canvas_diameter / 2) + Math.sqrt((Math.pow(x_coord, 2) + Math.pow(y_coord, 2)))
        });
        dialMax.css({
            width: cfg.canvas_diameter - cfg.cursor_diameter * 0.5
        });
    }, 100);


});
$(window).resize(function() {
	draw();
});


/*
 *      Drive the rover
 */
driveCmd = {d: 0, p: 0};
function driveRover(input) {
    $('#direction').html('Direction: ' + parseInt(input.direction)  + '% Power: ' + input.power + '%');

    if (driveCmd.d != input.direction || driveCmd.p != input.power) {
        driveCmd.d = input.direction;
        driveCmd.p = input.power;
        socket.emit('drive', {
            d: input.direction,
            p: input.power
        });
    }
    else {
        //cuts down on traffic by not sending the same input twice
        //console.log('ignore', input);
    }
}




/**
 *      Utility functions
 */
function status(status) {
    if (status == 'connected') {
        $('#origin')
            .addClass('active')
            .removeClass('inactive');
    }
    else {
        $('#origin')
            .addClass('inactive')
            .removeClass('active');
    }
}

function setSettingsTime() {
    var time = new Date().toLocaleString('en-US', {hour12: false}).split(',')[1].trim();
    $('#current-time').html('').html(time.substring(0, time.length - 3));
}
</script>


<script>

var inputRange = document.getElementsByClassName('pullee')[0],
maxValue = 150, // the higher the smoother when dragging
speed = 12, // thanks to @pixelass for this
currValue, rafID;

// set min/max value
inputRange.min = 0;
inputRange.max = maxValue;

// listen for unlock
function unlockStartHandler() {
    // clear raf if trying again
    window.cancelAnimationFrame(rafID);

    // set to desired value
    currValue = +this.value;
}

function unlockEndHandler() {

    // store current value
    currValue = +this.value;

    // determine if we have reached success or not
    if(currValue >= maxValue) {
        successHandler();
    }
    else {
        rafID = window.requestAnimationFrame(animateHandler);
    }
}

// handle range animation
function animateHandler() {

    // update input range
    inputRange.value = currValue;

    // determine if we need to continue
    if(currValue > -1) {
        window.requestAnimationFrame(animateHandler);
    }

    // decrement value
    currValue = currValue - speed;
}

// handle successful unlock
function successHandler() {
    $('.restart').addClass('active');
};

function resetRestart() {
    $('.restart').removeClass('active');
    $('.pullee').val(0);
    $('.option-restart').removeClass('slide-to-unlock');
}

$(document).ready(function() {
    // bind events
    inputRange.addEventListener('mousedown', unlockStartHandler, false);
    inputRange.addEventListener('mousestart', unlockStartHandler, false);
    inputRange.addEventListener('mouseup', unlockEndHandler, false);
    inputRange.addEventListener('touchend', unlockEndHandler, false);
});


</script>

<style>

.pullee {
  width: 80%;
  height: 40px;
  margin: 1px 0;
  background: transparent;
  appearance: none;
}
.pullee:active::-webkit-slider-thumb {
  appearance: none;
  transform: scale(1.1);
  cursor: -webkit-grabbing;
  cursor: -moz-grabbing;
}
.pullee:active::-moz-range-thumb {
  border: 0;
  transform: scale(1.1);
  cursor: -webkit-grabbing;
  cursor: -moz-grabbing;
}
.pullee:active::-ms-thumb {
  transform: scale(1.1);
  cursor: -webkit-grabbing;
  cursor: -moz-grabbing;
}
.pullee:focus {
  outline: none;
}
.pullee::-webkit-slider-thumb {
  appearance: none;
  display: block;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: #FFF;
  transform-origin: 50% 50%;
  transform: scale(1);
  transition: transform ease-out 100ms;
  cursor: -webkit-grab;
  cursor: -moz-grab;
}
.pullee::-moz-range-thumb {
  border: 0;
  display: block;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: #FFF;
  transform-origin: 50% 50%;
  transform: scale(1);
  transition: transform ease-out 100ms;
  cursor: -webkit-grab;
  cursor: -moz-grab;
}
.pullee::-ms-thumb {
  display: block;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: #FFF;
  transform-origin: 50% 50%;
  transform: scale(1);
  transition: transform ease-out 100ms;
  cursor: -webkit-grab;
  cursor: -moz-grab;
}
.pullee::-webkit-slider-runnable-track {
  height: 28px;
  padding: 5px;
  box-sizing: content-box;
  border-radius: 10rem;
  background-color: rgb(209, 213, 219);
}
.pullee::-moz-range-track {
  height: 28px;
  padding: 5px;
  box-sizing: content-box;
  border-radius: 10rem;
  background-color: rgb(209, 213, 219);
}
.pullee::-moz-focus-outer {
  border: 0;
}
.pullee::-ms-track {
  border: 0;
  height: 28px;
  padding: 5px;
  box-sizing: content-box;
  border-radius: 10rem;
  background-color: rgb(209, 213, 219);
  color: transparent;
}
.pullee::-ms-fill-lower, .pullee::-ms-fill-upper {
  background-color: transparent;
}
.pullee::-ms-tooltip {
  display: none;
}

</style>
